{% extends "base.html" %}
{% block title %}Create Journal Entry - StatementHub{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:financial_year_detail' pk=fy.pk %}">{{ fy.entity.entity_name }} - {{ fy.year_label }}</a></li>
                <li class="breadcrumb-item active">Create Journal Entry</li>
            </ol>
        </nav>
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-journal-plus"></i> Create Journal Entry</h5>
                <small class="text-muted">Journals are created as Draft. Post them to apply to the trial balance.</small>
            </div>
            <div class="card-body">
                <form method="post" id="journal-form">
                    {% csrf_token %}
                    <!-- Journal Header -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Type</label>
                            {{ form.journal_type }}
                            {% if form.journal_type.errors %}<div class="invalid-feedback d-block">{{ form.journal_type.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Journal Date</label>
                            {{ form.journal_date }}
                            {% if form.journal_date.errors %}<div class="invalid-feedback d-block">{{ form.journal_date.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            {{ form.description }}
                            {% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>{% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Narration / Notes <small class="text-muted">(optional, for audit trail)</small></label>
                            {{ form.narration }}
                        </div>
                    </div>

                    <!-- Journal Lines -->
                    <h6 class="mt-4 mb-2">Journal Lines</h6>
                    <div class="alert alert-info small py-2 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-info-circle"></i> Total debits must equal total credits. Select accounts from the dropdown or type a code.</span>
                        <span id="balance-indicator" class="fw-bold"></span>
                    </div>

                    {{ formset.management_form }}
                    <div class="table-responsive">
                        <table class="table table-sm" id="journal-lines">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 200px;">Account</th>
                                    <th style="width: 200px;">Account Name</th>
                                    <th>Description</th>
                                    <th style="width: 130px;">Debit</th>
                                    <th style="width: 130px;">Credit</th>
                                    <th style="width: 50px;">Del</th>
                                </tr>
                            </thead>
                            <tbody id="line-tbody">
                                {% for line_form in formset %}
                                <tr class="journal-line-row">
                                    <td class="account-picker-container">
                                        <div class="d-none">{{ line_form.account_code }}</div>
                                    </td>
                                    <td>
                                        <div class="d-none">{{ line_form.account_name }}</div>
                                    </td>
                                    <td>{{ line_form.description }}</td>
                                    <td>{{ line_form.debit }}</td>
                                    <td>{{ line_form.credit }}</td>
                                    <td class="text-center">
                                        {{ line_form.DELETE }}
                                        {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light fw-bold">
                                    <td colspan="3" class="text-end">Totals:</td>
                                    <td class="text-end" id="total-debit">$0.00</td>
                                    <td class="text-end" id="total-credit">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="add-line-btn">
                            <i class="bi bi-plus-lg"></i> Add Line
                        </button>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save as Draft
                            </button>
                            <a href="{% url 'core:financial_year_detail' pk=fy.pk %}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.account-picker-wrapper { position: relative; }
.account-picker-input { cursor: text; }
.account-dropdown {
    position: absolute; z-index: 1050; top: 100%; left: 0; right: 0;
    max-height: 250px; overflow-y: auto;
    background: #fff; border: 1px solid #dee2e6; border-top: none;
    border-radius: 0 0 .375rem .375rem;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    display: none;
}
.account-dropdown.show { display: block; }
.account-dropdown-item {
    padding: 6px 10px; cursor: pointer; font-size: 0.85rem;
    border-bottom: 1px solid #f0f0f0;
}
.account-dropdown-item:hover, .account-dropdown-item.active {
    background-color: #e9ecef;
}
.account-dropdown-item code { margin-right: 6px; color: #0d6efd; }
.account-dropdown-empty {
    padding: 8px 10px; font-size: 0.85rem; color: #6c757d; font-style: italic;
}
</style>

<script>
// Account data from server
const ACCOUNTS = {{ accounts|safe }};

// Normalise account data
const ACCOUNT_LIST = ACCOUNTS.map(function(acc) {
    return {
        code: acc.client_account_code || acc.code || '',
        name: acc.client_account_name || acc.name || ''
    };
});

document.addEventListener('DOMContentLoaded', function() {

    // ---- Searchable Account Picker ----
    function createAccountPicker(container) {
        const row = container.closest('tr');
        const codeInput = row.querySelector('[name$="-account_code"]');
        const nameInput = row.querySelector('[name$="-account_name"]');

        // Create the search input
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control form-control-sm account-picker-input';
        input.placeholder = 'Type code or name...';
        input.autocomplete = 'off';

        // Pre-fill if editing
        if (codeInput && codeInput.value) {
            const match = ACCOUNT_LIST.find(a => a.code === codeInput.value);
            input.value = match ? codeInput.value + ' - ' + match.name : codeInput.value;
        }

        // Create dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'account-dropdown';

        // Wrap
        const wrapper = document.createElement('div');
        wrapper.className = 'account-picker-wrapper';
        wrapper.appendChild(input);
        wrapper.appendChild(dropdown);
        container.innerHTML = '';
        container.appendChild(wrapper);

        let activeIndex = -1;

        function renderDropdown(filter) {
            dropdown.innerHTML = '';
            activeIndex = -1;
            const query = (filter || '').toLowerCase();
            const matches = query
                ? ACCOUNT_LIST.filter(a =>
                    a.code.toLowerCase().includes(query) ||
                    a.name.toLowerCase().includes(query))
                : ACCOUNT_LIST;

            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="account-dropdown-empty">No matching accounts</div>';
            } else {
                matches.forEach(function(acc, i) {
                    const item = document.createElement('div');
                    item.className = 'account-dropdown-item';
                    item.dataset.code = acc.code;
                    item.dataset.name = acc.name;
                    item.innerHTML = '<code>' + acc.code + '</code> ' + acc.name;
                    item.addEventListener('mousedown', function(e) {
                        e.preventDefault(); // Prevent blur
                        selectAccount(acc);
                    });
                    dropdown.appendChild(item);
                });
            }
            dropdown.classList.add('show');
        }

        function selectAccount(acc) {
            input.value = acc.code + ' - ' + acc.name;
            if (codeInput) codeInput.value = acc.code;
            if (nameInput) nameInput.value = acc.name;
            dropdown.classList.remove('show');
        }

        input.addEventListener('focus', function() {
            renderDropdown(input.value.split(' - ')[0]);
        });

        input.addEventListener('input', function() {
            renderDropdown(input.value);
        });

        input.addEventListener('blur', function() {
            setTimeout(function() { dropdown.classList.remove('show'); }, 150);
        });

        input.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.account-dropdown-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
                if (items[activeIndex]) items[activeIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
                items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
                if (items[activeIndex]) items[activeIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeIndex >= 0 && items[activeIndex]) {
                    const code = items[activeIndex].dataset.code;
                    const name = items[activeIndex].dataset.name;
                    selectAccount({ code, name });
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
                input.blur();
            } else if (e.key === 'Tab') {
                // Auto-select first match on Tab if there's a filter
                if (items.length > 0 && input.value) {
                    const code = items[0].dataset.code;
                    const name = items[0].dataset.name;
                    selectAccount({ code, name });
                }
                dropdown.classList.remove('show');
            }
        });

        return { input, dropdown, wrapper };
    }

    // Initialize existing pickers
    document.querySelectorAll('.account-picker-container').forEach(function(container) {
        createAccountPicker(container);
    });

    // Debit/Credit calculation
    function updateTotals() {
        let totalDr = 0, totalCr = 0;
        document.querySelectorAll('.journal-line-row').forEach(function(row) {
            const delCheck = row.querySelector('[name$="-DELETE"]');
            if (delCheck && delCheck.checked) return;
            const dr = parseFloat(row.querySelector('[name$="-debit"]')?.value) || 0;
            const cr = parseFloat(row.querySelector('[name$="-credit"]')?.value) || 0;
            totalDr += dr;
            totalCr += cr;
        });
        document.getElementById('total-debit').textContent = '$' + totalDr.toFixed(2);
        document.getElementById('total-credit').textContent = '$' + totalCr.toFixed(2);

        const indicator = document.getElementById('balance-indicator');
        const diff = Math.abs(totalDr - totalCr);
        if (totalDr === 0 && totalCr === 0) {
            indicator.textContent = '';
        } else if (diff < 0.01) {
            indicator.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Balanced</span>';
        } else {
            indicator.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Out of balance by $' + diff.toFixed(2) + '</span>';
        }
    }

    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.endsWith('-debit') || e.target.name.endsWith('-credit'))) {
            updateTotals();
        }
    });
    document.addEventListener('change', function(e) {
        if (e.target.name && e.target.name.endsWith('-DELETE')) {
            updateTotals();
        }
    });

    // Add line button
    document.getElementById('add-line-btn').addEventListener('click', function() {
        const totalForms = document.getElementById('id_lines-TOTAL_FORMS');
        const idx = parseInt(totalForms.value);
        const tbody = document.getElementById('line-tbody');

        const tr = document.createElement('tr');
        tr.className = 'journal-line-row';
        tr.innerHTML = `
            <td class="account-picker-container">
                <div class="d-none">
                    <input type="text" name="lines-${idx}-account_code" class="form-control form-control-sm" id="id_lines-${idx}-account_code">
                </div>
            </td>
            <td>
                <div class="d-none">
                    <input type="text" name="lines-${idx}-account_name" class="form-control form-control-sm" id="id_lines-${idx}-account_name">
                </div>
            </td>
            <td>
                <input type="text" name="lines-${idx}-description" class="form-control form-control-sm" id="id_lines-${idx}-description" placeholder="Line description (optional)">
            </td>
            <td>
                <input type="number" name="lines-${idx}-debit" step="0.01" min="0" class="form-control form-control-sm" id="id_lines-${idx}-debit">
            </td>
            <td>
                <input type="number" name="lines-${idx}-credit" step="0.01" min="0" class="form-control form-control-sm" id="id_lines-${idx}-credit">
            </td>
            <td class="text-center">
                <input type="checkbox" name="lines-${idx}-DELETE" id="id_lines-${idx}-DELETE">
                <input type="hidden" name="lines-${idx}-id" id="id_lines-${idx}-id">
                <input type="hidden" name="lines-${idx}-journal" id="id_lines-${idx}-journal">
            </td>
        `;
        tbody.appendChild(tr);

        // Initialize searchable account picker on the new row
        const container = tr.querySelector('.account-picker-container');
        createAccountPicker(container);

        totalForms.value = idx + 1;

        // Focus the new account picker input
        const newInput = container.querySelector('.account-picker-input');
        if (newInput) newInput.focus();
    });

    // Initial totals
    updateTotals();
});
</script>
{% endblock %}
