{% extends "base.html" %}
{% load humanize %}
{% block title %}Validate Import — Bulk Import — StatementHub{% endblock %}
{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:entity_list' %}">Entities</a></li>
        <li class="breadcrumb-item"><a href="{% url 'core:bulk_import_start' %}">Bulk Import</a></li>
        <li class="breadcrumb-item active">Validate</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header {% if errors %}bg-warning text-dark{% else %}bg-success text-white{% endif %}">
                <h5 class="mb-0">
                    {% if errors %}
                    <i class="bi bi-exclamation-triangle"></i> Validation Errors Found
                    {% else %}
                    <i class="bi bi-check-circle"></i> Validation Passed
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="border rounded p-3 text-center">
                            <h4>{{ total_rows }}</h4>
                            <small class="text-muted">Total Rows</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3 text-center">
                            <h4 class="text-success">{{ valid_row_count }}</h4>
                            <small class="text-muted">Valid Rows</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3 text-center">
                            <h4 class="{% if error_count %}text-danger{% else %}text-success{% endif %}">{{ error_count }}</h4>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3 text-center">
                            <small class="text-muted">File</small>
                            <p class="mb-0 fw-semibold">{{ job.original_filename }}</p>
                        </div>
                    </div>
                </div>

                {% if errors %}
                <div class="alert alert-danger">
                    <h6><i class="bi bi-x-circle"></i> {{ error_count }} validation error{{ error_count|pluralize }}</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th>Row</th>
                                    <th>Field</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for err in errors %}
                                <tr>
                                    <td>{{ err.row }}</td>
                                    <td><code>{{ err.field }}</code></td>
                                    <td>{{ err.message }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- Preview -->
                <h6 class="mt-4 mb-3">Data Preview (first 50 rows)</h6>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-bordered table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>#</th>
                                <th>Entity Name</th>
                                <th>Type</th>
                                <th>ABN</th>
                                <th>Email</th>
                                <th>Suburb</th>
                                <th>State</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in preview_rows %}
                            <tr>
                                <td>{{ row.row_num }}</td>
                                <td>{{ row.data.entity_name }}</td>
                                <td><span class="badge bg-secondary">{{ row.data.entity_type }}</span></td>
                                <td>{{ row.data.abn }}</td>
                                <td>{{ row.data.contact_email }}</td>
                                <td>{{ row.data.suburb }}</td>
                                <td>{{ row.data.state }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex gap-2 mt-4">
                    {% if not errors %}
                    <form method="post" action="{% url 'core:bulk_import_execute' pk=job.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-lg"
                                onclick="return confirm('Import {{ total_rows }} entities? This cannot be undone.')">
                            <i class="bi bi-check-circle"></i> Import {{ total_rows }} Entities
                        </button>
                    </form>
                    {% endif %}
                    <a href="{% url 'core:bulk_import_start' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Start Over
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
