{% extends "base.html" %}
{% block title %}Chart of Accounts - StatementHub{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-1"><i class="bi bi-diagram-3"></i> Chart of Accounts</h4>
        <p class="text-muted mb-0">MC&S entity-type-specific chart of accounts — {{ total_all }} accounts across all entity types</p>
    </div>
</div>

<!-- Entity Type Tabs -->
<ul class="nav nav-tabs mb-3">
    {% for et_value, et_info in entity_counts.items %}
    <li class="nav-item">
        <a class="nav-link {% if entity_type_filter == et_value %}active{% endif %}"
           href="?entity_type={{ et_value }}{% if query %}&q={{ query }}{% endif %}{% if section_filter %}&section={{ section_filter }}{% endif %}">
            {{ et_info.label }}
            <span class="badge bg-secondary bg-opacity-50 ms-1">{{ et_info.count }}</span>
        </a>
    </li>
    {% endfor %}
</ul>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-center">
            <input type="hidden" name="entity_type" value="{{ entity_type_filter }}">
            <div class="col-md-5">
                <input type="text" name="q" class="form-control form-control-sm"
                       placeholder="Search by code, name, or classification..."
                       value="{{ query }}">
            </div>
            <div class="col-md-4">
                <select name="section" class="form-select form-select-sm">
                    <option value="">All Sections</option>
                    {% for value, label in section_choices %}
                    <option value="{{ value }}" {% if section_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-search"></i> Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- Account count summary -->
<div class="mb-3">
    <small class="text-muted">
        Showing <strong>{{ total_accounts }}</strong> accounts for
        <strong>{{ entity_counts|dictsort:entity_type_filter }}</strong>
        {% for et_value, et_info in entity_counts.items %}
            {% if et_value == entity_type_filter %}{{ et_info.label }}{% endif %}
        {% endfor %}
        entities
        {% if query %} matching "<strong>{{ query }}</strong>"{% endif %}
        {% if section_filter %} in section "<strong>{{ section_filter }}</strong>"{% endif %}
    </small>
</div>

{% for section_label, accounts in grouped_accounts.items %}
<div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold">{{ section_label }}</h6>
        <span class="badge bg-light text-dark">{{ accounts|length }} accounts</span>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover mb-0">
            <thead>
                <tr class="small text-muted">
                    <th style="width: 100px;">Code</th>
                    <th>Account Name</th>
                    <th style="width: 250px;">Classification</th>
                    <th style="width: 80px;">Tax</th>
                </tr>
            </thead>
            <tbody>
                {% for acc in accounts %}
                <tr>
                    <td><code class="text-primary fw-bold">{{ acc.account_code }}</code></td>
                    <td>{{ acc.account_name }}</td>
                    <td><span class="text-muted" style="font-size: 0.85rem;">{{ acc.classification }}</span></td>
                    <td>
                        {% if acc.tax_code %}
                        <span class="badge {% if acc.tax_code == 'GST' %}bg-success{% elif acc.tax_code == 'ITS' %}bg-warning text-dark{% elif acc.tax_code == 'FRE' %}bg-info{% elif acc.tax_code == 'ADS' %}bg-secondary{% elif acc.tax_code == 'CAP' %}bg-primary{% elif acc.tax_code == 'INP' %}bg-danger{% else %}bg-light text-dark{% endif %} bg-opacity-75" style="font-size: 0.75rem;">
                            {{ acc.tax_code }}
                        </span>
                        {% else %}
                        <span class="text-muted" style="font-size: 0.75rem;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% empty %}
<div class="text-center py-5">
    <i class="bi bi-diagram-3 text-muted" style="font-size: 3rem;"></i>
    <h5 class="mt-3 text-muted">No accounts found</h5>
    <p class="text-muted">{% if query %}Try adjusting your search.{% else %}No chart of accounts has been loaded for this entity type.{% endif %}</p>
</div>
{% endfor %}
{% endblock %}
