{% extends "base.html" %}
{% load humanize %}
{% block title %}Review — {{ job.client_name }} — StatementHub{% endblock %}

{% block extra_head %}
<style>
    .review-header {
        background: white;
        border-radius: 12px;
        padding: 20px 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    .progress-counter {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a2e;
    }
    .progress-counter .total {
        color: #adb5bd;
        font-weight: 400;
    }
    .meta-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 3px 10px;
        font-size: 0.78rem;
        color: #495057;
    }
    .gst-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 10px;
        border-radius: 6px;
        font-size: 0.78rem;
        font-weight: 600;
    }
    .gst-registered { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .gst-not-registered { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
    .txn-table {
        font-size: 0.83rem;
    }
    .txn-table th {
        font-weight: 600;
        font-size: 0.76rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
    }
    .txn-table td {
        vertical-align: middle;
        padding: 8px 6px;
    }
    .txn-row-pending {
        background: #fffde7;
    }
    .txn-row-confirmed {
        background: #f1f8e9;
    }
    .txn-row-learning {
        background: #e8f5e9;
    }
    .amount-debit {
        color: #c62828;
        font-weight: 600;
    }
    .amount-credit {
        color: #2e7d32;
        font-weight: 600;
    }
    .gst-amount {
        color: #6c757d;
        font-size: 0.78rem;
    }
    .net-amount {
        font-weight: 600;
        font-size: 0.78rem;
    }
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 0.73rem;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
    }
    .conf-1 { background: #ffcdd2; color: #b71c1c; }
    .conf-2 { background: #ffe0b2; color: #e65100; }
    .conf-3 { background: #fff9c4; color: #f57f17; }
    .conf-4 { background: #c8e6c9; color: #2e7d32; }
    .conf-5 { background: #a5d6a7; color: #1b5e20; }
    .learning-badge {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        font-size: 0.7rem;
        padding: 1px 6px;
        border-radius: 10px;
        background: #e0f2f1;
        color: #00695c;
        font-weight: 600;
    }

    /* Searchable account picker */
    .account-picker-container {
        position: relative;
    }
    .account-picker-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 0.82rem;
        background: white;
    }
    .account-picker-input:focus {
        border-color: #4a90d9;
        outline: none;
        box-shadow: 0 0 0 2px rgba(74,144,217,0.15);
    }
    .account-picker-input.confirmed {
        border-color: #4caf50;
        background: #f1f8e9;
    }
    .account-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .account-dropdown.show {
        display: block;
    }
    .account-option {
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.82rem;
        border-bottom: 1px solid #f5f5f5;
    }
    .account-option:hover, .account-option.active {
        background: #e3f2fd;
    }
    .account-option .code {
        font-weight: 600;
        color: #1a1a2e;
        margin-right: 6px;
    }
    .account-option .name {
        color: #6c757d;
    }

    .tax-select {
        padding: 4px 6px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 0.82rem;
        background: white;
        min-width: 140px;
    }
    .tax-select.confirmed {
        border-color: #4caf50;
        background: #f1f8e9;
    }
    .status-icon {
        font-size: 1.1rem;
    }
    .btn-accept-all {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        color: #1565c0;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .btn-accept-all:hover {
        background: #bbdefb;
        color: #0d47a1;
    }
    .btn-submit-review {
        font-weight: 600;
        font-size: 0.9rem;
        padding: 10px 32px;
    }
    /* Classification progress */
    .classify-bar {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 12px 20px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .classify-bar .progress {
        flex: 1;
        height: 10px;
    }
    .classify-bar .classify-text {
        font-size: 0.85rem;
        color: #1565c0;
        font-weight: 600;
        white-space: nowrap;
    }
    .classify-bar .classify-spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #90caf9;
        border-top-color: #1565c0;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .txn-row-unclassified {
        background: #f5f5f5;
    }
    .txn-row-unclassified td {
        color: #9e9e9e;
    }
    .btn-classify {
        background: #1565c0;
        border: none;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 6px 16px;
        border-radius: 6px;
    }
    .btn-classify:hover {
        background: #0d47a1;
        color: white;
    }
    .btn-classify:disabled {
        background: #90caf9;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="review-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <a href="{% url 'review:dashboard' %}" class="text-decoration-none text-muted" style="font-size: 0.85rem;">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <h4 class="mt-2 mb-1 fw-bold">{{ job.client_name }}</h4>
            <div class="text-muted mb-2" style="font-size: 0.85rem;">
                <i class="bi bi-file-earmark-pdf text-danger"></i> {{ job.file_name }}
                <span class="mx-2">&middot;</span>
                <i class="bi bi-calendar3"></i> Received {{ job.received_at|date:"d/m/Y" }}
                {% if job.submitted_by %}
                <span class="mx-2">&middot;</span>
                <i class="bi bi-person"></i> {{ job.submitted_by }}
                {% endif %}
            </div>
            <!-- Bank statement metadata and GST status -->
            <div class="d-flex flex-wrap gap-2 mt-1">
                {% if job.is_gst_registered %}
                <span class="gst-badge gst-registered"><i class="bi bi-check-circle-fill"></i> GST Registered</span>
                {% else %}
                <span class="gst-badge gst-not-registered"><i class="bi bi-x-circle-fill"></i> Not GST Registered</span>
                {% endif %}
                {% if job.bank_account_name %}
                <span class="meta-badge"><i class="bi bi-bank"></i> {{ job.bank_account_name }}</span>
                {% endif %}
                {% if job.bsb %}
                <span class="meta-badge">BSB: {{ job.bsb }}</span>
                {% endif %}
                {% if job.account_number %}
                <span class="meta-badge">Acc: {{ job.account_number }}</span>
                {% endif %}
                {% if job.period_start %}
                <span class="meta-badge"><i class="bi bi-calendar-range"></i> {{ job.period_start }} — {{ job.period_end }}</span>
                {% endif %}
                {% if job.source == "email" %}
                <span class="meta-badge"><i class="bi bi-envelope"></i> Via Email</span>
                {% elif job.source == "upload" %}
                <span class="meta-badge"><i class="bi bi-upload"></i> Manual Upload</span>
                {% endif %}
            </div>
        </div>
        <div class="text-end">
            <div class="progress-counter">
                <span id="confirmed-count">{{ job.confirmed_count }}</span>
                <span class="total">/ {{ job.flagged_count }}</span>
            </div>
            <small class="text-muted">confirmed</small>
            <div class="progress mt-2" style="height: 8px; width: 180px;">
                <div id="progress-bar" class="progress-bar bg-success" style="width: {{ job.progress_percent }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Classification Progress Bar -->
<div id="classify-bar" class="classify-bar" style="display: none;">
    <div class="classify-spinner" id="classify-spinner"></div>
    <div class="classify-text" id="classify-text">Classifying transactions...</div>
    <div class="progress" style="flex: 1;">
        <div id="classify-progress" class="progress-bar bg-primary" style="width: 0%; transition: width 0.3s;"></div>
    </div>
    <span class="classify-text" id="classify-count">0 / {{ job.total_transactions }}</span>
</div>

<!-- Action Bar -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <span class="text-muted" style="font-size: 0.85rem;">
            {{ job.total_transactions }} total transactions &middot;
            <span id="auto-coded-count">{{ job.auto_coded_count }}</span> auto-coded &middot;
            <strong>{{ job.flagged_count }} flagged for review</strong>
        </span>
    </div>
    <div class="d-flex gap-2">
        <button id="btn-classify" class="btn btn-classify" onclick="startClassification()">
            <i class="bi bi-robot"></i> Classify with AI
        </button>
        <button id="btn-accept-all" class="btn btn-accept-all" onclick="acceptAllSuggestions()">
            <i class="bi bi-magic"></i> Accept All AI Suggestions
        </button>
        <button id="btn-submit" class="btn btn-success btn-submit-review" onclick="submitReview()" disabled>
            <i class="bi bi-check2-all"></i> Submit Review
        </button>
    </div>
</div>

<!-- Transaction Table -->
<div class="bg-white rounded-3" style="box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden;">
    <div class="table-responsive">
        <table class="table txn-table mb-0">
            <thead>
                <tr>
                    <th style="width: 30px;"></th>
                    <th>Date</th>
                    <th>Description</th>
                    <th class="text-end">Gross</th>
                    {% if job.is_gst_registered %}
                    <th class="text-end">GST</th>
                    <th class="text-end">Net</th>
                    {% endif %}
                    <th>AI Suggestion</th>
                    <th style="min-width: 220px;">Confirmed Code</th>
                    <th style="min-width: 150px;">Tax Type</th>
                </tr>
            </thead>
            <tbody id="txn-body">
                {% for txn in transactions %}
                <tr id="row-{{ txn.pk }}"
                    class="{% if txn.is_confirmed %}txn-row-confirmed{% elif txn.ai_confidence == 0 %}txn-row-unclassified{% elif txn.from_learning %}txn-row-learning{% else %}txn-row-pending{% endif %}"
                    data-txn-id="{{ txn.pk }}"
                    data-ai-code="{{ txn.ai_suggested_code }}"
                    data-ai-name="{{ txn.ai_suggested_name }}"
                    data-confirmed="{{ txn.is_confirmed|yesno:'true,false' }}">
                    <td>
                        <span class="status-icon">
                            {% if txn.is_confirmed %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                            <i class="bi bi-circle text-warning"></i>
                            {% endif %}
                        </span>
                    </td>
                    <td style="white-space: nowrap;">{{ txn.date }}</td>
                    <td>
                        {{ txn.description }}
                        {% if txn.from_learning %}
                        <span class="learning-badge"><i class="bi bi-lightbulb-fill"></i> Learned</span>
                        {% endif %}
                    </td>
                    <td class="text-end {% if txn.amount < 0 %}amount-debit{% else %}amount-credit{% endif %}" style="white-space: nowrap;">
                        ${{ txn.amount|floatformat:2 }}
                    </td>
                    {% if job.is_gst_registered %}
                    <td class="text-end gst-amount" style="white-space: nowrap;">
                        {% if txn.gst_amount %}${{ txn.gst_amount|floatformat:2 }}{% else %}—{% endif %}
                    </td>
                    <td class="text-end net-amount" style="white-space: nowrap;">
                        ${{ txn.net_amount|floatformat:2 }}
                    </td>
                    {% endif %}
                    <td>
                        <div>
                            <span style="font-weight: 600;">{{ txn.ai_suggested_code }}</span>
                            <span class="text-muted">{{ txn.ai_suggested_name }}</span>
                        </div>
                        <span class="confidence-badge conf-{{ txn.ai_confidence }}">
                            {% for i in "12345" %}{% if forloop.counter <= txn.ai_confidence %}<i class="bi bi-star-fill"></i>{% else %}<i class="bi bi-star"></i>{% endif %}{% endfor %}
                        </span>
                        {% if txn.ai_reasoning %}
                        <span class="text-muted d-block" style="font-size: 0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ txn.ai_reasoning }}">
                            {{ txn.ai_reasoning }}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="account-picker-container">
                            <input type="text"
                                   class="account-picker-input {% if txn.is_confirmed %}confirmed{% endif %}"
                                   id="acct-{{ txn.pk }}"
                                   value="{% if txn.confirmed_code %}{{ txn.confirmed_code }} — {{ txn.confirmed_name }}{% endif %}"
                                   placeholder="Type code or name..."
                                   data-code="{{ txn.confirmed_code }}"
                                   data-name="{{ txn.confirmed_name }}"
                                   autocomplete="off">
                            <div class="account-dropdown" id="dropdown-{{ txn.pk }}"></div>
                        </div>
                    </td>
                    <td>
                        <select class="tax-select {% if txn.is_confirmed %}confirmed{% endif %}"
                                id="tax-{{ txn.pk }}"
                                onchange="onTaxChange('{{ txn.pk }}')">
                            <option value="">— Select —</option>
                            <option value="GST on Income" {% if txn.confirmed_tax_type == "GST on Income" %}selected{% endif %}>GST on Income</option>
                            <option value="GST on Expenses" {% if txn.confirmed_tax_type == "GST on Expenses" %}selected{% endif %}>GST on Expenses</option>
                            <option value="GST Free Income" {% if txn.confirmed_tax_type == "GST Free Income" %}selected{% endif %}>GST Free Income</option>
                            <option value="GST Free Expenses" {% if txn.confirmed_tax_type == "GST Free Expenses" %}selected{% endif %}>GST Free Expenses</option>
                            <option value="Input Taxed" {% if txn.confirmed_tax_type == "Input Taxed" %}selected{% endif %}>Input Taxed</option>
                            <option value="BAS Excluded" {% if txn.confirmed_tax_type == "BAS Excluded" %}selected{% endif %}>BAS Excluded</option>
                            <option value="N-T" {% if txn.confirmed_tax_type == "N-T" %}selected{% endif %}>Not Reportable</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Summary row for GST registered -->
{% if job.is_gst_registered %}
<div class="bg-white rounded-3 mt-3 p-3" style="box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
    <div class="row text-center">
        <div class="col">
            <small class="text-muted d-block">Opening Balance</small>
            <strong>${{ job.opening_balance|floatformat:2 }}</strong>
        </div>
        <div class="col">
            <small class="text-muted d-block">Closing Balance</small>
            <strong>${{ job.closing_balance|floatformat:2 }}</strong>
        </div>
        <div class="col">
            <small class="text-muted d-block">Total GST</small>
            <strong id="total-gst">—</strong>
        </div>
        <div class="col">
            <small class="text-muted d-block">Total Net</small>
            <strong id="total-net">—</strong>
        </div>
    </div>
</div>
{% endif %}

<!-- Submit bar (sticky bottom) -->
<div class="d-flex justify-content-end mt-4 mb-4">
    <button id="btn-submit-bottom" class="btn btn-success btn-submit-review btn-lg" onclick="submitReview()" disabled>
        <i class="bi bi-check2-all"></i> Submit Review
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
const ACCOUNTS = {{ accounts_json|safe }};
const JOB_ID = "{{ job.pk }}";
const FLAGGED_COUNT = {{ job.flagged_count }};
const IS_GST_REGISTERED = {{ job.is_gst_registered|yesno:"true,false" }};
const CSRF_TOKEN = "{{ csrf_token }}";
let activeDropdown = null;
let activeIndex = -1;

// ---- Account Picker ----
document.querySelectorAll('.account-picker-input').forEach(input => {
    const txnId = input.id.replace('acct-', '');
    const dropdown = document.getElementById('dropdown-' + txnId);

    input.addEventListener('focus', () => {
        showDropdown(txnId, input.value);
    });

    input.addEventListener('input', () => {
        showDropdown(txnId, input.value);
    });

    input.addEventListener('keydown', (e) => {
        const options = dropdown.querySelectorAll('.account-option');
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = Math.min(activeIndex + 1, options.length - 1);
            highlightOption(dropdown, activeIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = Math.max(activeIndex - 1, 0);
            highlightOption(dropdown, activeIndex);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0 && options[activeIndex]) {
                selectAccount(txnId, options[activeIndex].dataset.code, options[activeIndex].dataset.name);
            }
        } else if (e.key === 'Tab') {
            if (activeIndex >= 0 && options[activeIndex]) {
                selectAccount(txnId, options[activeIndex].dataset.code, options[activeIndex].dataset.name);
            } else if (options.length > 0) {
                selectAccount(txnId, options[0].dataset.code, options[0].dataset.name);
            }
            hideAllDropdowns();
        } else if (e.key === 'Escape') {
            hideAllDropdowns();
        }
    });
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('.account-picker-container')) {
        hideAllDropdowns();
    }
});

function showDropdown(txnId, query) {
    const dropdown = document.getElementById('dropdown-' + txnId);
    const q = (query || '').toLowerCase().replace(/\s*—\s*.*/, '').trim();
    activeIndex = -1;

    let filtered = ACCOUNTS;
    if (q) {
        filtered = ACCOUNTS.filter(a =>
            a.code.toLowerCase().includes(q) ||
            a.name.toLowerCase().includes(q)
        );
    }

    if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="p-2 text-muted" style="font-size:0.82rem;">No matching accounts</div>';
    } else {
        let lastSection = '';
        let html = '';
        filtered.slice(0, 40).forEach(a => {
            if (a.section && a.section !== lastSection) {
                html += `<div class="px-2 py-1 bg-light border-bottom" style="font-size:0.7rem; font-weight:600; color:#666;">${a.section}</div>`;
                lastSection = a.section;
            }
            const taxBadge = a.tax ? `<span class="badge bg-secondary bg-opacity-25 text-dark" style="font-size:0.65rem; margin-left:4px;">${a.tax}</span>` : '';
            html += `<div class="account-option" data-code="${a.code}" data-name="${a.name}" onclick="selectAccount('${txnId}', '${a.code}', '${a.name.replace(/'/g, "\\'")}')"> 
                <span class="code">${a.code}</span>
                <span class="name">${a.name}${taxBadge}</span>
            </div>`;
        });
        dropdown.innerHTML = html;
    }
    dropdown.classList.add('show');
    activeDropdown = dropdown;
}

function highlightOption(dropdown, index) {
    dropdown.querySelectorAll('.account-option').forEach((opt, i) => {
        opt.classList.toggle('active', i === index);
        if (i === index) opt.scrollIntoView({ block: 'nearest' });
    });
}

function hideAllDropdowns() {
    document.querySelectorAll('.account-dropdown').forEach(d => d.classList.remove('show'));
    activeDropdown = null;
    activeIndex = -1;
}

function selectAccount(txnId, code, name) {
    const input = document.getElementById('acct-' + txnId);
    input.value = code + ' — ' + name;
    input.dataset.code = code;
    input.dataset.name = name;
    input.classList.add('confirmed');
    hideAllDropdowns();

    // Auto-confirm if tax type is also set
    tryAutoConfirm(txnId);
}

function onTaxChange(txnId) {
    const select = document.getElementById('tax-' + txnId);
    if (select.value) {
        select.classList.add('confirmed');
    }
    tryAutoConfirm(txnId);
}

function tryAutoConfirm(txnId) {
    const input = document.getElementById('acct-' + txnId);
    const select = document.getElementById('tax-' + txnId);
    const code = input.dataset.code;
    const name = input.dataset.name;
    const tax = select.value;

    if (code && tax) {
        confirmTransaction(txnId, code, name, tax);
    }
}

function confirmTransaction(txnId, code, name, taxType) {
    fetch(`/api/review/transaction/${txnId}/confirm/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
        },
        body: JSON.stringify({
            confirmed_code: code,
            confirmed_name: name,
            confirmed_tax_type: taxType,
        }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            const row = document.getElementById('row-' + txnId);
            row.classList.remove('txn-row-pending');
            row.classList.add('txn-row-confirmed');
            row.dataset.confirmed = 'true';
            row.querySelector('.status-icon').innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';

            // Update GST/Net if returned
            if (IS_GST_REGISTERED && data.gst_amount !== undefined) {
                const gstCell = row.querySelector('.gst-amount');
                const netCell = row.querySelector('.net-amount');
                if (gstCell) gstCell.textContent = '$' + parseFloat(data.gst_amount).toFixed(2);
                if (netCell) netCell.textContent = '$' + parseFloat(data.net_amount).toFixed(2);
            }

            // Update progress
            document.getElementById('confirmed-count').textContent = data.confirmed_count;
            document.getElementById('progress-bar').style.width = data.progress_percent + '%';

            // Enable submit if all confirmed
            const allConfirmed = data.confirmed_count >= FLAGGED_COUNT;
            document.getElementById('btn-submit').disabled = !allConfirmed;
            document.getElementById('btn-submit-bottom').disabled = !allConfirmed;
        }
    });
}

// ---- Accept All AI Suggestions ----
function acceptAllSuggestions() {
    if (!confirm('Accept all AI suggestions for unconfirmed transactions? You can still change individual items afterwards.')) return;

    fetch(`/api/review/${JOB_ID}/accept-all/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            // Reload the page to show updated state
            window.location.reload();
        }
    });
}

// ---- Submit Review ----
function submitReview() {
    if (!confirm('Submit this review? All confirmed patterns will be saved to the learning database.')) return;

    fetch(`/api/review/${JOB_ID}/submit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            window.location.href = data.redirect || '/';
        } else {
            alert(data.message || 'Error submitting review.');
        }
    });
}

// ---- Async Classification ----
let classifyRunning = false;
const TOTAL_TXNS = {{ job.total_transactions }};
const INITIAL_AUTO_CODED = {{ job.auto_coded_count }};

function startClassification() {
    if (classifyRunning) return;
    classifyRunning = true;

    const bar = document.getElementById('classify-bar');
    const btn = document.getElementById('btn-classify');
    bar.style.display = 'flex';
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Classifying...';

    classifyNextBatch();
}

function classifyNextBatch() {
    fetch(`/api/review/${JOB_ID}/classify-batch/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
        },
        body: JSON.stringify({batch_size: 15}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            // Update each classified transaction in the table
            (data.classified || []).forEach(c => {
                updateTransactionRow(c);
            });

            // Update progress
            const coded = data.auto_coded_count || 0;
            const pct = TOTAL_TXNS > 0 ? Math.round((coded / TOTAL_TXNS) * 100) : 0;
            document.getElementById('classify-progress').style.width = pct + '%';
            document.getElementById('classify-count').textContent = coded + ' / ' + TOTAL_TXNS;
            document.getElementById('classify-text').textContent = 'Classifying transactions... ' + pct + '%';
            document.getElementById('auto-coded-count').textContent = coded;

            // Update confirmed count
            if (data.confirmed_count !== undefined) {
                document.getElementById('confirmed-count').textContent = data.confirmed_count;
                const progressPct = FLAGGED_COUNT > 0 ? Math.round((data.confirmed_count / FLAGGED_COUNT) * 100) : 0;
                document.getElementById('progress-bar').style.width = progressPct + '%';
            }

            // Continue if more to classify
            if (data.remaining > 0) {
                classifyNextBatch();
            } else {
                classifyComplete();
            }
        } else {
            classifyError(data.message || 'Unknown error');
        }
    })
    .catch(err => {
        classifyError(err.message || 'Network error');
    });
}

function classifyComplete() {
    classifyRunning = false;
    const bar = document.getElementById('classify-bar');
    const btn = document.getElementById('btn-classify');

    document.getElementById('classify-spinner').style.display = 'none';
    document.getElementById('classify-text').textContent = 'Classification complete!';
    document.getElementById('classify-progress').style.width = '100%';
    document.getElementById('classify-progress').classList.remove('bg-primary');
    document.getElementById('classify-progress').classList.add('bg-success');

    btn.innerHTML = '<i class="bi bi-check-circle"></i> Classification Complete';
    btn.classList.remove('btn-classify');
    btn.classList.add('btn-success');
    btn.disabled = true;

    // Fade out the bar after 3 seconds
    setTimeout(() => {
        bar.style.transition = 'opacity 0.5s';
        bar.style.opacity = '0';
        setTimeout(() => { bar.style.display = 'none'; }, 500);
    }, 3000);
}

function classifyError(msg) {
    classifyRunning = false;
    const btn = document.getElementById('btn-classify');
    document.getElementById('classify-text').textContent = 'Error: ' + msg;
    document.getElementById('classify-spinner').style.display = 'none';
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry Classification';
}

function updateTransactionRow(c) {
    const row = document.getElementById('row-' + c.txn_id);
    if (!row) return;

    // Update row class
    row.classList.remove('txn-row-unclassified', 'txn-row-pending');
    if (c.is_confirmed) {
        row.classList.add('txn-row-confirmed');
        row.querySelector('.status-icon').innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
    } else if (c.from_learning) {
        row.classList.add('txn-row-learning');
    } else {
        row.classList.add('txn-row-pending');
    }

    // Update AI suggestion column
    const aiCellIdx = IS_GST_REGISTERED ? 6 : 4;
    const aiCell = row.cells[aiCellIdx];
    if (aiCell) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += i <= c.confidence ? '<i class="bi bi-star-fill"></i>' : '<i class="bi bi-star"></i>';
        }
        aiCell.innerHTML =
            '<div><span style="font-weight:600;">' + c.code + '</span> ' +
            '<span class="text-muted">' + c.name + '</span></div>' +
            '<span class="confidence-badge conf-' + c.confidence + '">' + stars + '</span>' +
            (c.reasoning ? '<span class="text-muted d-block" style="font-size:0.7rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + c.reasoning + '">' + c.reasoning + '</span>' : '');
    }

    // Update GST/Net columns if GST registered
    if (IS_GST_REGISTERED) {
        const gstCell = row.querySelector('.gst-amount');
        const netCell = row.querySelector('.net-amount');
        if (gstCell && c.gst_amount) gstCell.textContent = '$' + parseFloat(c.gst_amount).toFixed(2);
        if (netCell && c.net_amount) netCell.textContent = '$' + parseFloat(c.net_amount).toFixed(2);
    }

    // Update the account picker and tax select with AI suggestions
    const acctInput = document.getElementById('acct-' + c.txn_id);
    const taxSelect = document.getElementById('tax-' + c.txn_id);

    if (acctInput && !acctInput.dataset.code) {
        acctInput.value = c.code + ' \u2014 ' + c.name;
        acctInput.dataset.code = c.code;
        acctInput.dataset.name = c.name;
    }

    if (taxSelect && !taxSelect.value && c.tax_type) {
        taxSelect.value = c.tax_type;
    }

    // Update row data attributes
    row.dataset.aiCode = c.code;
    row.dataset.aiName = c.name;
    row.dataset.confirmed = c.is_confirmed ? 'true' : 'false';

    // Re-enable text color for the row
    row.querySelectorAll('td').forEach(td => td.style.color = '');
}

// ---- Auto-start classification if there are unclassified transactions ----
(function() {
    const autoCoded = INITIAL_AUTO_CODED;
    if (autoCoded < TOTAL_TXNS) {
        // There are unclassified transactions - auto-start
        setTimeout(() => startClassification(), 500);
    } else {
        // All classified - hide the classify button
        const btn = document.getElementById('btn-classify');
        if (btn) {
            btn.innerHTML = '<i class="bi bi-check-circle"></i> All Classified';
            btn.classList.remove('btn-classify');
            btn.classList.add('btn-success');
            btn.disabled = true;
        }
    }
})();

// ---- Initial state: enable submit if all already confirmed ----
(function() {
    const confirmed = {{ job.confirmed_count }};
    if (confirmed >= FLAGGED_COUNT && FLAGGED_COUNT > 0) {
        document.getElementById('btn-submit').disabled = false;
        document.getElementById('btn-submit-bottom').disabled = false;
    }
})();
</script>
{% endblock %}
